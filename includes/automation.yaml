- alias: TV sala
  trigger:
    - platform: state
      entity_id: media_player.tv_sala
      from: 'off'
      to: 'playing'
    - platform: state
      entity_id: media_player.tv_sala
      to: 'off'
      for:
        seconds: 10
  action:
    - service_template: >
        {% if is_state('media_player.tv_sala' , 'playing') and is_state('switch.home_theater_sala', 'off') %}
          switch.turn_on
        {% elif is_state('media_player.tv_sala' , 'off') and is_state('switch.home_theater_sala', 'on') %}
          switch.turn_off
        {% endif %}
      entity_id: switch.home_theater_sala
    - service_template: >
        {% if is_state('media_player.tv_sala' , 'playing') and is_state('light.ledsalatv', 'off') %}
          light.turn_on
        {% endif %}
      data:
        entity_id: light.ledsalatv
        effect: colorloop
    - service_template: >
        {% if is_state('media_player.tv_sala' , 'off') and is_state('light.ledsalatv', 'on') %}
          light.turn_off
        {% endif %}
      data:
        entity_id: light.ledsalatv
    - condition: state
      entity_id: media_player.tv_sala
      state: 'playing'
    - delay: 00:00:06
    - service: notify.tv_sala
      data_template:
        message: "Olá! A temperatura da sala é de {{ states.sensor.temperatura_sala.state | int }}ºC. Lá fora está {{ states.sensor.dark_sky_summary.state | lower }} com {{ states.sensor.dark_sky_temperature.state | int }}ºC."

- alias: Ações de reinicialização
  trigger:
    platform: homeassistant
    event: start
  action:
    - service: frontend.set_theme
      data_template:
        name: "darkred"
    - service: mqtt.publish
      data:
        payload: ""
        topic: "cmnd/sonoffs/power"
        qos: 0
        retain: 0
    - service: input_select.select_option
      entity_id: input_select.estados_de_succao
      data_template:
        option: Balanceado
    - service: cover.close_cover
      entity_id:
        - cover.garagem_muvrh_interno
        - cover.garagem_muvrh_rua
        - cover.garagem_casa
    - service_template: >
        {% if states.sun.sun.attributes.elevation > 3 %}
          homeassistant.turn_off
        {% else %}
          homeassistant.turn_on
        {% endif %}
      entity_id:
        - automation.luzes_da_casa__banheiro_social
        - automation.luzes_da_casa__banheiro_suite
        - automation.luzes_da_casa__cozinha
        - automation.luzes_da_casa__quarto
        - automation.luzes_da_casa__suite
        - automation.luzes_da_casa__sala
        - automation.luzes_da_casa__entrando_em_casa
        - automation.muvrh_203__luz_do_banheiro
        - automation.muvrh_203__luz_da_sala_de_operacoes
        - automation.muvrh_203__luz_da_nossa_sala
        - automation.muvrh_303__luz_do_banheiro
        - automation.muvrh_303__luz_da_dinamica
        - automation.muvrh_303__luz_da_entrada
    - service: input_select.select_option
      entity_id: input_select.estados_de_succao
      data_template:
        option: >
          {% if states.vacuum.aspirador.attributes.fan_speed == 'Quiet' %}
            Silencioso
          {% elif states.vacuum.aspirador.attributes.fan_speed == 'Balanced' %}
            Balanceado
          {% elif states.vacuum.aspirador.attributes.fan_speed == 'Turbo' %}
            Turbo
          {% elif states.vacuum.aspirador.attributes.fan_speed == 'Max' %}
            Turbo máximo
          {% elif states.vacuum.aspirador.attributes.fan_speed == '105' %}
            Pano úmido
          {% endif %}
    - service_template: >
        {% if is_state('alarm_control_panel.alarme', 'disarmed') %}
          {% if is_state('group.pessoas', 'home') %}script.alarme_armar_casa{% else %}script.alarme_armar_fora{% endif %}
        {% endif %}
    - service_template: >
        {% if (is_state('light.gateway_light_34ce0090940e', 'on' ) or is_state('light.gateway_light_34ce0090940e', 'off' )) %}
          homekit.start
        {% else %}
          script.homekit_no_start
        {% endif %}
    - service: homeassistant.turn_on
      entity_id: automation.alarme__aviso_alarme_ativado
    - service: persistent_notification.create
      data:
        title: "Alerta Sistema ({{now().strftime('%H:%M')}})"
        message: "Hassio iniciado com sucesso."
    - service: media_player.volume_set
      entity_id: media_player.sala
      data:
        volume_level: 0.7
    - service: media_player.play_media
      data:
        entity_id: media_player.sala
        media_content_id: 'http://192.168.1.12:8123/local/audio/tts/sistema_reiniciado.mp3'
        media_content_type: 'audio/mp3'
    - service: notify.ios_iphone_de_antonio
      data:
        title: "Sistema"
        message: "Home Assistant foi reinicializado"

- alias: Garagem MuvRH
  trigger:
    - platform: state
      entity_id: input_boolean.entrar_muvrh
      from: 'off'
      to: 'on'
    - platform: state
      entity_id: input_boolean.sair_muvrh
      from: 'off'
      to: 'on'
  action:
    - service_template: >
        {% if is_state('input_boolean.entrar_muvrh', 'on') %}
          notify.TUDO
        {% endif %}
      data:
        title: "Garagem MuvRH"
        message: "Bem vindo! Abrindo garagem do trabalho..."
    - service_template: >
        {% if is_state('input_boolean.entrar_muvrh', 'on') %}
          script.garagem_muvrh_entrar
        {% endif %}
    - service_template: >
        {% if is_state('input_boolean.sair_muvrh', 'on') %}
          notify.TUDO
        {% endif %}
      data:
        title: "Garagem MuvRH"
        message: "Até logo! Abrindo garagem do trabalho..."
    - service_template: >
        {% if is_state('input_boolean.sair_muvrh', 'on') %}
          script.garagem_muvrh_sair
        {% endif %}

- alias: Alarme - Rearmar automaticamente
  trigger:
    platform: state
    entity_id: alarm_control_panel.alarme
    to: 'disarmed'
  action:
    - service: media_player.volume_set
      entity_id: media_player.sala
      data:
        volume_level: 0.7
    - service: media_player.play_media
      data:
        entity_id: media_player.sala
        media_content_id: 'http://192.168.1.12:8123/local/audio/tts/alarme_desarmado.mp3'
        media_content_type: 'audio/mp3'
    - service: notify.TUDO
      data:
        title: "Alarme da casa"
        message: "O alarme da casa foi desarmado. Rearmando em 10 minutos..."
    - condition: state
      entity_id: alarm_control_panel.alarme
      state: 'disarmed'
    - delay: 00:10:00
    - service_template: >
        {% if is_state('group.pessoas', 'home') %}
        alarm_control_panel.alarm_arm_home
        {% else %}
        alarm_control_panel.alarm_arm_away
        {% endif %}
      entity_id: alarm_control_panel.alarme

- alias: Alarme - Aviso alarme ativado
  initial_state: False
  trigger:
    platform: state
    entity_id: alarm_control_panel.alarme
    from: 'disarmed'
  action:
    - service: media_player.volume_set
      entity_id: media_player.sala
      data:
        volume_level: 0.7
    - service: media_player.play_media
      data:
        entity_id: media_player.sala
        media_content_id: 'http://192.168.1.12:8123/local/audio/tts/alarme_armado.mp3'
        media_content_type: 'audio/mp3'
    - service: notify.TUDO
      data:
        title: "Alarme da casa"
        message: "O alarme da casa foi armado."

- alias: Sensores - Porta da entrada aberta - Casa
  trigger:
    platform: state
    entity_id: binary_sensor.entrada_casa
    to: 'on'
  action:
    - service: script.entrada_luz_temporizador
    - service: notify.TUDO
      data:
        title: "Alerta casa"
        message: "Porta da entrada de casa acabou de ser aberta."
    - service_template: >
        {% if is_state('switch.sistema_alarme_casa', 'on') %}
          alarm_control_panel.alarm_trigger
        {% endif %}
      entity_id: alarm_control_panel.alarme
    - service_template: >
        {% if is_state('switch.sistema_alarme_casa', 'off') %}
          script.tts_porta_entrada
        {% else %}
          script.tts_entrando_casa_alarme
        {% endif %}

- alias: Alarme - Disparar
  trigger:
    platform: state
    entity_id: alarm_control_panel.alarme
    to: 'triggered'
  action:
    - service: switch.turn_on
      entity_id: switch.sirene
    - service: notify.TUDO
      data:
        title: "Alarme da casa"
        message: "ATENÇÂO! Alarme foi acionado! Sirene está tocando!"

- alias: Chegar em casa
  trigger:
    platform: state
    entity_id: input_boolean.chegar_casa
    to: 'on'
  action:
    - service: script.garagem_casa_abrir
    - service: notify.TUDO
      data_template:
        title: "Automação"
        message: "Bem vindo! Preparando a casa para sua chegada..."
    - service: media_player.volume_set
      entity_id: media_player.sala
      data:
        volume_level: 0.7
    - service: media_player.play_media
      data:
        entity_id: media_player.sala
        media_content_id: 'http://192.168.1.12:8123/local/audio/tts/automacao_chegando_em_casa.mp3'
        media_content_type: 'audio/mp3'
    - delay: 00:01:00
    - service: alarm_control_panel.alarm_disarm
      entity_id: alarm_control_panel.alarme
    - service: input_boolean.turn_off
      entity_id: input_boolean.chegar_casa
    - wait_template: "{{is_state('binary_sensor.entrada_casa', 'on')}}"
      timeout: 00:09:00
      continue_on_timeout: false
    - delay: 00:00:20
    - service_template: >
        {% if is_state('switch.tv_lg_sala', 'off') %}
          switch.turn_on
        {% endif %}
      entity_id: switch.tv_lg_sala

- alias: Desligar toalheiro após 2 horas
  trigger:
    platform: state
    entity_id: switch.toalheiro
    to: 'on'
    for:
      hours: 2
  action:
    - service: switch.turn_off
      entity_id: switch.toalheiro
    - service: notify.TUDO
      data_template:
        title: "Automação"
        message: "Toalheiro desligado após duas horas de uso."

- alias: Desligar chuveiro após 20 minutos
  trigger:
    platform: state
    entity_id:
      - switch.chuveirosuite
      - switch.chuveirosocial
    to: 'on'
    for:
      minutes: 20
  action:
    - service: switch.turn_off
      entity_id:
        - switch.chuveirosuite
        - switch.chuveirosocial
    - service: notify.TUDO
      data_template:
        title: "Automação"
        message: "{{ trigger.to_state.name }} desligado após 20 minutos de uso."

- alias: Alerta - Chuveiro ligado sem ninguém em casa
  trigger:
    platform: state
    entity_id:
      - switch.chuveirosuite
      - switch.chuveirosocial
    to: 'on'
  condition:
    condition: state
    entity_id: group.pessoas
    state: 'not_home'
  action:
    - service: notify.TUDO
      data_template:
        title: "Alerta importante"
        message: "{{ trigger.to_state.name }} foi ligado sem ninguém em casa! ATENÇÂO!"


- alias: Luzes da casa - Entrando em casa
  trigger:
    platform: state
    entity_id: binary_sensor.entrada_casa
    to: 'on'
  condition:
    condition: state
    entity_id: light.mesa_jantar
    state: 'off'
  action:
    - service: light.turn_on
      entity_id: light.mesa_jantar

- alias: Sensores - Porta ou janela aberta por muito tempo - Casa
  trigger:
    platform: state
    entity_id:
      - binary_sensor.entrada_casa
    to: 'on'
    for:
      minutes: 1
  action:
    - service: media_player.volume_set
      entity_id: media_player.sala
      data:
        volume_level: 0.7
    - service: tts.amazon_polly_say
      entity_id: media_player.sala
      data_template:
        message: <speak>Atenção! {{ trigger.to_state.name }} aberta por muito tempo!</speak>
    - service: notify.TUDO
      data_template:
        title: 'Alerta Casa'
        message: 'Atenção: {{ trigger.to_state.name }} aberta por muito tempo!'

- alias: Sensores - Porta ou janela aberta por muito tempo - MuvRH
  trigger:
    platform: state
    entity_id:
      - binary_sensor.door_window_sensor_158d0001bf2a09
      - binary_sensor.door_window_sensor_158d0001b8671f
    to: 'on'
    for:
      minutes: 1
  action:
    - service: notify.TUDO
      data_template:
        title: 'Alerta MuvRH'
        message: 'Atenção: {{ trigger.to_state.name }} aberta por muito tempo!'

- alias: Rotina - Bom dia
  trigger:
    platform: state
    entity_id: input_boolean.bom_dia
    to: 'on'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.boa_noite
    - service: script.tts_bom_dia
    - service: notify.TODOS_CELULARES
      data_template:
        title: "Automação"
        message: "Bom dia! Hoje a máxima será de {{ states.sensor.dark_sky_daily_high_temperature.state | int }}ºC com previsão de {{ states.sensor.dark_sky_summary.state | lower }}"
    - service: switch.turn_on
      entity_id: switch.toalheiro
    - service_template: >
        {% if is_state('climate.ar_condicionado_da_suite' , 'off') %}
        {% else %}
          {% if is_state('climate.ar_condicionado_da_suite' , 'heat') %}
          {% else %}
            climate.set_operation_mode
          {% endif %}
        {% endif %}
      data:
        entity_id: climate.ar_condicionado_da_suite
        operation_mode: 'off'
    - wait_template: "{{is_state('script.tts_bom_dia', 'off')}}"
    - service: switch.turn_on
      entity_id: switch.tv_lg_suite
    - delay: 00:05:00
    - service: input_boolean.turn_off
      entity_id: input_boolean.bom_dia

- alias: Rotina - Boa noite
  trigger:
    platform: state
    entity_id: input_boolean.boa_noite
    to: 'on'
  action:
    - service: notify.TODOS_CELULARES
      data:
        title: "Automação"
        message: "Aprontando a casa. Boa noite!"
    - service: automation.turn_off
      entity_id:
        - automation.luzes_da_casa__suite
        - automation.luzes_da_casa__quarto
    - service: script.casa_desligar_tudo_noite
    - wait_template: "{{is_state('script.casa_desligar_tudo_noite', 'off')}}"
    - service: script.tts_boa_noite

- alias: Rotina - Ações ao por do sol
  trigger:
    platform: sun
    event: sunset
    offset: '-00:15:00'
  action:
    - service: homeassistant.turn_on
      entity_id:
        - automation.luzes_da_casa__banheiro_social
        - automation.luzes_da_casa__banheiro_suite
        - automation.luzes_da_casa__cozinha
        - automation.luzes_da_casa__quarto
        - automation.luzes_da_casa__suite
        - automation.luzes_da_casa__sala
        - automation.luzes_da_casa__entrando_em_casa
#        - automation.muvrh_203__luz_da_entrada
        - automation.muvrh_203__luz_do_banheiro
        - automation.muvrh_203__luz_da_sala_de_operacoes
        - automation.muvrh_203__luz_da_nossa_sala
        - automation.muvrh_303__luz_da_entrada
        - automation.muvrh_303__luz_da_dinamica
        - automation.muvrh_303__luz_do_banheiro

- alias: Rotina - Ações ao nascer do sol
  trigger:
    platform: sun
    event: sunrise
    offset: '-00:15:00'
  action:
    - service: homeassistant.turn_off
      entity_id:
        - automation.luzes_da_casa__banheiro_social
        - automation.luzes_da_casa__banheiro_suite
        - automation.luzes_da_casa__cozinha
        - automation.luzes_da_casa__quarto
        - automation.luzes_da_casa__suite
        - automation.luzes_da_casa__sala
        - automation.luzes_da_casa__entrando_em_casa
#        - automation.muvrh_203__luz_da_entrada
        - automation.muvrh_203__luz_do_banheiro
        - automation.muvrh_203__luz_da_sala_de_operacoes
        - automation.muvrh_203__luz_da_nossa_sala
        - automation.muvrh_303__luz_da_entrada
        - automation.muvrh_303__luz_da_dinamica
        - automation.muvrh_303__luz_do_banheiro
    - service: cover.close_cover
      entity_id: cover.persiana_sala

- alias: Alerta - Uso CPU em alta por muito tempo
  trigger:
    platform: numeric_state
    entity_id: sensor.cpu_used
    value_template: '{{ states.sensor.cpu_used.state | int }}'
    above: 20
    for:
      minutes: 5
  action:
    - service: notify.ios_iphone_de_antonio
      data_template:
        title: "Sistema"
        message: "O CPU do Pi3 está muito alto por mais de 5 minutos. No momento está a {{ states.sensor.cpu_used.state | int }}%."
    - service: persistent_notification.create
      data_template:
        title: "Alerta Sistema ({{now().strftime('%H:%M')}})"
        message: "Sistema ficou com o CPU alto por mais de 5 minitos."

# Botões Xiaomi#

- alias: Botão Xiaomi quarto
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_botao_quarto_01'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.click in ('single','double','triple','quadruple','many','long') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.click == 'single' %}
          script.botao_xiaomi_quarto_01_single
        {% elif trigger.payload_json.click == 'double' %}
          script.botao_xiaomi_quarto_01_double
        {% elif trigger.payload_json.click == 'triple' %}
          script.botao_xiaomi_quarto_01_triple
        {% elif trigger.payload_json.click == 'quadruple' %}
          script.botao_xiaomi_quarto_01_quadruple
        {% elif trigger.payload_json.click == 'many' %}
          script.botao_xiaomi_quarto_01_many
        {% elif trigger.payload_json.click == 'long' %}
          script.botao_xiaomi_quarto_01_long
        {% else %}
        {% endif %}

- alias: Botão Xiaomi suite 01
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_botao_suite_01'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.click in ('single','double','triple','quadruple','many','long') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.click == 'single' %}
          script.botao_xiaomi_suite_01_single
        {% elif trigger.payload_json.click == 'double' %}
          script.botao_xiaomi_suite_01_double
        {% elif trigger.payload_json.click == 'triple' %}
          script.botao_xiaomi_suite_01_triple
        {% elif trigger.payload_json.click == 'quadruple' %}
          script.botao_xiaomi_suite_01_quadruple
        {% elif trigger.payload_json.click == 'many' %}
          script.botao_xiaomi_suite_01_many
        {% elif trigger.payload_json.click == 'long' %}
          script.botao_xiaomi_suite_01_long
        {% else %}
        {% endif %}

- alias: Botão Xiaomi suite 02
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_botao_suite_02'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.click in ('single','double','triple','quadruple','many','long') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.click == 'single' %}
          script.botao_xiaomi_suite_02_single
        {% elif trigger.payload_json.click == 'double' %}
          script.botao_xiaomi_suite_02_double
        {% elif trigger.payload_json.click == 'triple' %}
          script.botao_xiaomi_suite_02_triple
        {% elif trigger.payload_json.click == 'quadruple' %}
          script.botao_xiaomi_suite_02_quadruple
        {% elif trigger.payload_json.click == 'many' %}
          script.botao_xiaomi_suite_02_many
        {% elif trigger.payload_json.click == 'long' %}
          script.botao_xiaomi_suite_02_long
        {% else %}
        {% endif %}

- alias: Botão Xiaomi banheiro suite
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_botao_banheiro_suite_01'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.click in ('single','double','triple','quadruple','many','long') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.click == 'single' %}
          script.botao_xiaomi_banheiro_suite_01_single
        {% elif trigger.payload_json.click == 'double' %}
          script.botao_xiaomi_banheiro_suite_01_double
        {% elif trigger.payload_json.click == 'triple' %}
          script.botao_xiaomi_banheiro_suite_01_triple
        {% elif trigger.payload_json.click == 'quadruple' %}
          script.botao_xiaomi_banheiro_suite_01_quadruple
        {% elif trigger.payload_json.click == 'many' %}
          script.botao_xiaomi_banheiro_suite_01_many
        {% elif trigger.payload_json.click == 'long' %}
          {% if is_state('switch.chuveirosuite' , 'off') %}
            script.botao_xiaomi_banheiro_suite_01_long
          {% else %}
            homeassistant.turn_off
          {% endif %}
        {% else %}
        {% endif %}
      data_template:
        entity_id: >
          {% if is_state('switch.chuveirosuite' , 'on') %}
            switch.chuveirosuite, script.botao_xiaomi_banheiro_suite_click_3
          {% endif %}

- alias: Botão Xiaomi banheiro social
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_botao_banheiro_social_01'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.click in ('single','double','triple','quadruple','many','long') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.click == 'single' %}
          script.botao_xiaomi_banheiro_social_01_single
        {% elif trigger.payload_json.click == 'double' %}
          script.botao_xiaomi_banheiro_social_01_double
        {% elif trigger.payload_json.click == 'triple' %}
          script.botao_xiaomi_banheiro_social_01_triple
        {% elif trigger.payload_json.click == 'quadruple' %}
          script.botao_xiaomi_banheiro_social_01_quadruple
        {% elif trigger.payload_json.click == 'many' %}
          script.botao_xiaomi_banheiro_social_01_many
        {% elif trigger.payload_json.click == 'long' %}
          {% if is_state('switch.chuveirosocial' , 'off') %}
            script.botao_xiaomi_banheiro_social_01_long
          {% else %}
            homeassistant.turn_off
          {% endif %}
        {% else %}
        {% endif %}
      data_template:
        entity_id: >
          {% if is_state('switch.chuveirosocial' , 'on') %}
            switch.chuveirosocial, script.botao_xiaomi_banheiro_social_click_3
          {% endif %}

- alias: Botão Xiaomi sala 01
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_botao_sala_01'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.click in ('single','double','triple','quadruple','many','long') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.click == 'single' %}
          script.botao_xiaomi_sala_01_single
        {% elif trigger.payload_json.click == 'double' %}
          script.botao_xiaomi_sala_01_double
        {% elif trigger.payload_json.click == 'triple' %}
          script.botao_xiaomi_sala_01_triple
        {% elif trigger.payload_json.click == 'quadruple' %}
          script.botao_xiaomi_sala_01_quadruple
        {% elif trigger.payload_json.click == 'many' %}
          script.botao_xiaomi_sala_01_many
        {% elif trigger.payload_json.click == 'long' %}
          script.botao_xiaomi_sala_01_long
        {% else %}
        {% endif %}

- alias: Botão Xiaomi sala 02
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_botao_sala_02'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.click in ('single','double','triple','quadruple','many','long') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.click == 'single' %}
          script.botao_xiaomi_sala_02_single
        {% elif trigger.payload_json.click == 'double' %}
          script.botao_xiaomi_sala_02_double
        {% elif trigger.payload_json.click == 'triple' %}
          script.botao_xiaomi_sala_02_triple
        {% elif trigger.payload_json.click == 'quadruple' %}
          script.botao_xiaomi_sala_02_quadruple
        {% elif trigger.payload_json.click == 'many' %}
          script.botao_xiaomi_sala_02_many
        {% elif trigger.payload_json.click == 'long' %}
          script.botao_xiaomi_sala_02_long
        {% else %}
        {% endif %}

- alias: Botão Xiaomi cozinha
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_botao_cozinha_01'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.click in ('single','double','triple','quadruple','many','long') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.click == 'single' %}
          script.botao_xiaomi_cozinha_01_single
        {% elif trigger.payload_json.click == 'double' %}
          script.botao_xiaomi_cozinha_01_double
        {% elif trigger.payload_json.click == 'triple' %}
          script.botao_xiaomi_cozinha_01_triple
        {% elif trigger.payload_json.click == 'quadruple' %}
          script.botao_xiaomi_cozinha_01_quadruple
        {% elif trigger.payload_json.click == 'many' %}
          script.botao_xiaomi_cozinha_01_many
        {% elif trigger.payload_json.click == 'long' %}
          script.botao_xiaomi_cozinha_01_long
        {% else %}
        {% endif %}

- alias: Solicitar status celulares
  trigger:
    platform: time
    minutes: '/60'
    seconds: 00
  action:
    - service: notify.TODOS_CELULARES
      data:
        message: "request_location_update"

- alias: Luzes da casa - LED Desktop sala
  trigger:
    - platform: state
      entity_id: switch.desktop
  action:
    - service_template: >
        {% if is_state('switch.desktop' , 'on') %}
          light.turn_on
        {% elif is_state('switch.desktop' , 'off') %}
          light.turn_off
        {% endif %}
      data:
        entity_id: light.ledsaladesktop

- alias: MuvRH 203 - Ligar tudo quando primeiro chegar
  initial_state: True
  trigger:
    platform: state
    entity_id: binary_sensor.door_window_sensor_158d0001bf2a09
    from: 'off'
    to: 'on'
  condition:
    condition: and
    conditions:
      - condition: time
        after: '06:00:00'
        before: '16:00:00'
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: state
        entity_id: group.muvrh_movimento_203
        state: 'off'
        for:
          hours: 4
          minutes: 0
          seconds: 0
  action:
    - service: persistent_notification.create
      data:
        title: "Alerta MuvRH ({{now().strftime('%H:%M')}})"
        message: "Chegou alguém na sala 203."
    - wait_template: "{{is_state('binary_sensor.motion_sensor_158d0001e420d0', 'on')}}"
      timeout: 00:05:00
      continue_on_timeout: false
    - service: light.turn_on
      entity_id: light.muv203operacoes
    - delay: 00:00:03
    - service: notify.TODOS_CELULARES
      data_template:
        title: "Alerta MuvRH"
        message: "Chegou alguém na sala 203"
        data:
          attachment:
            content-type: jpeg
          push:
            category: camera
          entity_id: camera.muvrh_203__operacoes
    - service: switch.turn_on
      entity_id:
        - switch.tv_sala_operacoes
        - switch.muv203bebedouro
    - condition: or
      conditions:
        - condition: template
          value_template: "{% if (states.climate.ar_condicionado_da_sala_de_operacoes.attributes.current_temperature | int  < 20) %}True{% else %}False{% endif %}"
        - condition: template
          value_template: "{% if (states.climate.ar_condicionado_da_sala_de_operacoes.attributes.current_temperature | int  > 24) %}True{% else %}False{% endif %}"
    - service: climate.set_operation_mode
      data_template:
        entity_id: climate.ar_condicionado_da_sala_de_operacoes
        operation_mode: >
          {% if states.climate.ar_condicionado_da_sala_de_operacoes.attributes.current_temperature | int > 24 %}
            cool
          {% elif states.climate.ar_condicionado_da_sala_de_operacoes.attributes.current_temperature | int < 20 %}
            heat
          {% endif %}

- alias: Sensores - Portas - MuvRH
  trigger:
    platform: state
    entity_id:
      - binary_sensor.door_window_sensor_158d0001bf2a09
      - binary_sensor.door_window_sensor_158d0001b8671f
    to: 'on'
  action:
    - service: notify.TODAS_TVS
      data_template:
        title: "Alerta MuvRH"
        message: "Porta da {{ trigger.to_state.name | lower }} acabou de ser aberta."
    - condition: state
      entity_id: group.muvrh_movimento_203
      state: 'off'
      for:
        hours: 0
        minutes: 30
        seconds: 0
    - condition: state
      entity_id: group.muvrh_movimento_303
      state: 'off'
      for:
        hours: 0
        minutes: 30
        seconds: 0
    - service: notify.TODOS_CELULARES
      data_template:
        title: "Alerta MuvRH"
        message: "Porta da {{ trigger.to_state.name | lower }} acabou de ser aberta."

# Cubos

- alias: Cubo sala
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_cubo_sala_01'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.action in ('flip90','flip180','tap','shake','fall','rotate_right','rotate_left') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.action == 'flip90' %}
          script.cubo_sala_tv_aovivo
        {% elif trigger.payload_json.action == 'flip180' %}
          script.cubo_sala_tv_youtube
        {% elif trigger.payload_json.action == 'tap' %}
          script.cubo_sala_luz
        {% elif trigger.payload_json.action == 'shake' %}
          script.cubo_sala_tv_toggle
        {% elif trigger.payload_json.action == 'fall' %}
          script.cubo_sala_persiana
        {% elif trigger.payload_json.action == 'rotate_right' %}
          script.home_theater_sala_volup_x3
        {% elif trigger.payload_json.action == 'rotate_left' %}
          script.home_theater_sala_voldown_x3
        {% else %}
        {% endif %}

- alias: Cubo suíte
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/casa_xiaomi_cubo_suite_01'
  condition:
    condition: template
    value_template: "{{ trigger.payload_json.action in ('flip90','flip180','tap','shake','fall','rotate_right','rotate_left') }}"
  action:
    - service_template: >
        {% if trigger.payload_json.action == 'flip90' %}
          script.cubo_suite_tv_aovivo
        {% elif trigger.payload_json.action == 'flip180' %}
          script.cubo_suite_tv_youtube
        {% elif trigger.payload_json.action == 'tap' %}
          script.cubo_suite_luz
        {% elif trigger.payload_json.action == 'shake' %}
          script.cubo_suite_tv_toggle
        {% elif trigger.payload_json.action == 'fall' %}
          script.cubo_suite_persiana
        {% elif trigger.payload_json.action == 'rotate_right' %}
          script.cubo_suite_tv_volup
        {% elif trigger.payload_json.action == 'rotate_left' %}
          script.cubo_suite_tv_voldown
        {% else %}
        {% endif %}

- alias: Alerta - Bateria fraca
  trigger:
    - platform: time
      minutes: '/60'
      seconds: 00
  condition:
    condition: template
    value_template: >
      {% set threshold = 10 -%}
      {%- for item in states.binary_sensor or states.sensor if item.attributes.battery_level is defined and item.attributes['battery_level'] | int < threshold or item.state | lower == "unknown" -%}
      {%- if loop.first -%}
      {{ true }}
      {%- endif -%}
      {%- endfor %}
  action:
    - service: persistent_notification.create
      data_template:
        title: "Alerta Dispositivo({{now().strftime('%H:%M')}})"
        message: "Bateria muito fraca do dispositivo {% for state in states if state.domain in ['switch','binary_sensor','sensor'] and state.attributes.battery_level is defined and state.attributes.battery_level < 10 -%}{%- if loop.first %}{% elif loop.last %} e {% else %}, {% endif -%}{{ state.name }} ({{ state.attributes.battery_level |int }}%){%- else -%}Nenhum{%- endfor %}"
        notification_id: "bateria"
    - service: notify.ios_iphone_de_antonio
      data_template:
        title: "Bateria fraca"
        message: "Bateria muito fraca do dispositivo {% for state in states if state.domain in ['switch','binary_sensor','sensor'] and state.attributes.battery_level is defined and state.attributes.battery_level < 10 -%}{%- if loop.first %}{% elif loop.last %} e {% else %}, {% endif -%}{{ state.name }} ({{ state.attributes.battery_level |int }}%){%- else -%}Nenhum{%- endfor %}"

- alias: Alerta - Dispositivo indisponível
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.cube_158d00010b2e3e
        - binary_sensor.cube_158d00010b2e64
        - binary_sensor.door_window_sensor_158d0001b8671f
        - binary_sensor.door_window_sensor_158d0001bf2a09
        - binary_sensor.entrada_casa
        - binary_sensor.box_banheiro_suite
        - binary_sensor.box_banheiro_social
        - binary_sensor.movimento_suite
        - binary_sensor.movimento_sala
        - binary_sensor.movimento_cozinha
        - binary_sensor.movimento_quarto
        - binary_sensor.movimento_banheiro_suite
        - binary_sensor.movimento_banheiro_social
        - binary_sensor.motion_sensor_158d0001ad6b83
        - binary_sensor.motion_sensor_158d0001ad6c20
        - binary_sensor.motion_sensor_158d0001e02f9a
        - binary_sensor.motion_sensor_158d0001e420d0
        - binary_sensor.motion_sensor_158d0001e43ef1
        - binary_sensor.motion_sensor_158d0001e44035
        - binary_sensor.motion_sensor_158d0001a24bdc
      to: 'unavailable'
      for:
        minutes: 15
    - platform: state
      entity_id:
        - light.area_servico
        - light.banheiro_social_principal
        - light.banheiro_social_espelho
        - light.corredor
        - light.cozinha
        - light.entrada
        - light.gateway_light_34ce0090940e
        - light.ledcozinhabalcao
        - light.ledchaocozinha
        - light.ledquartotv
        - light.ledsaladesktop
        - light.ledsalatv
        - light.ledsuitecama
        - light.ledsuitetv
        - light.mesa_jantar
        - light.muv203banheiro
        - light.muv203entrada
        - light.muv203nossasala
        - light.muv203operacoes
        - light.quarto
        - light.sala_principal
        - light.suite_banheiro_principal
        - light.suite_banheiro_espelho
        - light.suite_principal
        - light.muv303entrada
        - light.muv303dinamica
        - light.muv303corredor
        - light.muv303banheiro
        - light.303leddinamica
      to: 'unavailable'
      for:
        minutes: 5
    - platform: state
      entity_id:
        - sensor.humidity_158d00015633b4
        - sensor.umidade_sala
        - sensor.umidade_quarto
        - sensor.humidity_158d0001703b44
        - sensor.umidade_cozinha
        - sensor.humidity_158d0001d7e65d
        - sensor.umidade_suite
        - sensor.illumination_158d0001ad6b83
        - sensor.illumination_158d0001ad6c20
        - sensor.illumination_158d0001e02f9a
        - sensor.illumination_158d0001e420d0
        - sensor.illumination_158d0001e43ef1
        - sensor.illumination_158d0001e44035
        - sensor.illumination_34ce00907e65
        - sensor.illumination_34ce0090940e
        - sensor.temperature_158d00015633b4
        - sensor.temperatura_quarto
        - sensor.temperature_158d0001703b44
        - sensor.temperature_158d0001d7e65d
        - sensor.temperatura_suite
      to: 'unavailable'
      for:
        minutes: 15
    - platform: state
      entity_id:
        - switch.chuveirosocial
        - switch.chuveirosuite
        - switch.muv203bebedouro
        - switch.sirene
        - switch.toalheiro
        - switch.muv303bebedouro
      to: 'unavailable'
      for:
        minutes: 5
    - platform: state
      entity_id:
        - media_player.suite
        - media_player.sala
      to: 'unavailable'
      for:
        minutes: 15
    - platform: state
      entity_id:
        - device_tracker.nas
        - device_tracker.tabletaut
        - device_tracker.ipad_casa
        - device_tracker.ipod
        - device_tracker.xiaomi_hub_casa
        - device_tracker.rmprosuite
        - device_tracker.rmminisala
        - device_tracker.rmminiquarto
        - device_tracker.impressorahpcasa
        - device_tracker.camera_sala
        - device_tracker.camera_cozinha
        - device_tracker.google_home_mini_sala
        - device_tracker.google_home_mini_suite
        - device_tracker.rfbridgecasa
        - device_tracker.aspirador_xiaomi
      to: 'not_home'
      for:
        minutes: 15
    - platform: state
      entity_id:
        - device_tracker.camera_01
        - device_tracker.camera_02
        - device_tracker.camera_03
        - device_tracker.camera_04
        - device_tracker.camera_05
        - device_tracker.camera_muvrh_operacoes
        - device_tracker.xiaomi_hub_muvrh
        - device_tracker.rfbridgemuvrh
        - device_tracker.rmpro_sala203
        - device_tracker.rmminientrada203
        - device_tracker.rmminioperacoes
        - device_tracker.rmminisala303
        - device_tracker.chromecast_sala303
      to: 'not_home'
      for:
        minutes: 15
    - platform: state
      entity_id:
        - device_tracker.orangepi_pihole
      to: 'not_home'
      for:
        minutes: 1
    - platform: state
      entity_id:
        - sensor.estado_do_bridge
      to: 'offline'
      for:
        minutes: 1
  action:
    - service: notify.ios_iphone_de_antonio
      data_template:
        title: "Dispositivo indisponível"
        message: "O dispositivo {{ trigger.to_state.name }} ficou indisponível."
    - service: persistent_notification.create
      data_template:
        title: "Alerta Dispositivo ({{now().strftime('%H:%M')}})"
        message: "O dispositivo {{ trigger.to_state.name }} ficou indisponível."

- alias: MuvRH 303 - Luz do corredor e LED
  trigger:
    platform: state
    entity_id: light.muv303entrada
  action:
    - service_template: >
        {% if is_state('light.muv303entrada', 'on') %}
          light.turn_on
        {% elif is_state('light.muv303entrada', 'off') %}
          light.turn_off
        {% endif %}
      entity_id:
        - light.muv303corredor
        - light.303leddinamica

- alias: Push - Iniciar componente HomeKit
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: START_HOMEKIT
  action:
    - service: homekit.start

- alias: Push - Reiniciar Home Assistant
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: RESTART_HA
  action:
    - service: homeassistant.restart

- alias: Push - Testes
  trigger:
    platform: event
    event_type: ios.notification_action_fired
  action:
    - service_template: >
        {% if trigger.event.data.actionName == 'TESTE_1' %}
          script.cubo_sala_luz
        {% elif trigger.event.data.actionName == 'TESTE_2' %}
          script.cubo_sala_persiana
        {% endif %}

- alias: MuvRH - Desligar tudo
  initial_state: True
  trigger:
    platform: state
    entity_id: input_boolean.muvrh_desligar_tudo
    to: 'on'
  action:
    - service: script.muvrh_desligar_tudo
    - delay: 00:00:10
    - service: input_boolean.turn_off
      entity_id: input_boolean.muvrh_desligar_tudo